var coverageCSV,blockUICss={border:"none",padding:"5px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"5px",opacity:.5,color:"#fff"},allowed=!1,selectedTests=[],compilationErrors=[];function successAcknowledgement(e){$("#acknowledgement").html(e.text).show(),setTimeout(function(){$("#acknowledgement").hide()},5e3),$.unblockUI()}function updateInvalidClasses(e){var s={},t=[];console.log(e.records);for(idx in e.records)s[e.records[idx].Id]=e.records[idx].Name;var o={};console.log(compilationErrors);for(idx in compilationErrors)(o={}).name=s[compilationErrors[idx]],o.id=compilationErrors[idx],t.push(o);console.log(s);var n=$("#notcompiled").html(),a=Mustache.render(n,t);document.getElementById("compilationErrors").innerHTML=a,$("#compilationErrors button").on("click",openTestClass),$("#compilationErrors").show(),$.unblockUI(),$(window).scrollTop($("#compilationErrors").offset().top)}function updateTestResults(e){createErrorCSVReport(e.testResults),$.unblockUI()}function updateOrgWideCoverage(e){document.getElementById("orgWideCoverage").innerHTML=e.records[0].PercentCovered+"%",$("#classProgress").css("width",e.records[0].PercentCovered+"%"),updateProgressBar(e.records[0].PercentCovered),chrome.tabs.query({currentWindow:!0,active:!0},function(e){chrome.tabs.sendMessage(e[0].id,{execute:"getCodeCoverage"},function(e){})})}function updateCoverage(e){var s=document.getElementById("coverageDiv"),t=document.getElementById("table"),o=Mustache.render($(t).html(),e);$(s).html(o),$("#getCoverageReport").show(),coverageCSV=e,$("#specificTests").hide(),$("#runSelected").hide(),$("#coverageDiv table").DataTable({bPaginate:!0,bLengthChange:!1,bFilter:!0,bDestroy:!0,bInfo:!1,bAutoWidth:!1,pageLength:10}),$("#coverageDiv").show(),$("#getCoverageReport").show(),$.unblockUI()}function updateProgressBar(e){var s="progress-bar progress-bar-animated bg-danger",t="progress-bar progress-bar-animated bg-warning",o="progress-bar progress-bar-animated bg-info",n="progress-bar progress-bar-animated bg-success",a="progress-bar progress-bar-animated";e<50?$("#classProgress").prop("class",s):e>=50&&e<65?$("#classProgress").prop("class",t):e>=65&&e<75?$("#classProgress").prop("class",o):e>=75&&e<90?$("#classProgress").prop("class",n):e>=90&&$("#classProgress").prop("class",a)}function processTestClasses(e){var s=[];compilationErrors=[],getTestAllClasses(e.records,s,compilationErrors),console.log(s);var t,o=$("#row").html();t=Mustache.render(o,s),document.getElementById("specificTests").innerHTML=t,selectedTests=[],$("#specificTests tr").on("click",function(){var e=$(this).find("input");$(e).prop("checked")?($(e).prop("checked",!1),removeArrayElement(selectedTests,$(e).attr("data-id"))):($(e).prop("checked",!0),selectedTests.push($(e).attr("data-id")))}),$("#specificTests table").DataTable({bPaginate:!0,bLengthChange:!1,bFilter:!0,bDestroy:!0,bInfo:!1,bAutoWidth:!1,pageLength:10}),$("#coverageDiv").hide(),$("#getCoverageReport").hide(),$("#runSelected").show(),$("#specificTests").show(),$.unblockUI(),compilationErrors.length>0&&chrome.tabs.query({currentWindow:!0,active:!0},function(e){chrome.tabs.sendMessage(e[0].id,{execute:"getInvalidApexClasses"},function(e){})})}function getTestAllClasses(e,s,t){var o={};for(index in e)o={},null!=e[index].SymbolTable&&1==e[index].IsValid&&determineTestClass(e[index].SymbolTable.tableDeclaration.annotations)&&(o.id=e[index].Id,o.name=e[index].SymbolTable.name,o.namespace=e[index].SymbolTable.namespace,s.push(o)),null==e[index].SymbolTable&&0==e[index].IsValid&&t.push(e[index].Id)}function determineTestClass(e){for(idx in e)if("IsTest"===e[idx].name)return!0;return!1}function createErrorCSVReport(e){var s={},t={},o=[];for(data in e)(t={}).Class_Name=e[data].ApexClass.Name,t.Method=e[data].MethodName,t.Status=e[data].Outcome,t.Stack_Trace=e[data].StackTrace,t.Message=e[data].Message,t.RunTime=e[data].RunTime,o.push(t);s.csvFields=["Class_Name","Method","Status","Stack_Trace","Message","RunTime"],s.csvJSON=o,getCSV(s,"ErrorReport")}function getCSV(e,s){var t=e.csvFields.join(),o="";for(data in e.csvJSON){o=[];var n;for(fields in e.csvFields)o.push(e.csvJSON[data][e.csvFields[fields]]);n=o.join(),t+="\r\n",t+=n}console.log(t),chrome.tabs.query({currentWindow:!0,active:!0},function(e){chrome.tabs.sendMessage(e[0].id,{execute:"saveFile",file:t,name:s},function(e){})})}function removeArrayElement(e,s){var t=e.indexOf(s);-1!==t&&e.splice(t,1)}function openTestClass(){var e=$(this).attr("data-id");chrome.tabs.query({currentWindow:!0,active:!0},function(s){chrome.tabs.sendMessage(s[0].id,{execute:"openTestClass",id:e},function(e){})})}$("#runSelected").hide(),$("#getCoverageReport").hide(),$.blockUI({message:'<span>Loading...</span>&nbsp; <div>Are you on Lightning? Open: <button style="margin:5px;" class="btn btn-default btn-sm btn-light" id="DevConsole">Developer Console</button></div>&nbsp; It works there!',css:blockUICss}),chrome.tabs.query({currentWindow:!0,active:!0},function(e){document.getElementById("DevConsole").addEventListener("click",function(){chrome.tabs.sendMessage(e[0].id,{execute:"openStandardPage",page:"DevConsole"},function(e){})});var s=["https://.*.salesforce.com/.*","https://.*.force.com/.*"],t=e[0].url;console.log(t);for(idx in s){new RegExp(s[idx]).test(t)&&(allowed=!0)}allowed?(chrome.tabs.sendMessage(e[0].id,{execute:"getOrgWideCoverage"},function(e){}),document.getElementById("coverage").addEventListener("click",function(){$.blockUI({message:"<span>Working on it..</span>",css:blockUICss}),chrome.tabs.sendMessage(e[0].id,{execute:"getCodeCoverage"},function(e){})}),document.getElementById("confirmRunAll").addEventListener("click",function(){$(".modal").hide(),chrome.tabs.sendMessage(e[0].id,{execute:"runAllTests"},function(e){});var s=document.createAttribute("disabled");s.value="true",document.getElementById("runAll").setAttributeNode(s),$.blockUI({message:"<span>Queueing all tests..</span>",css:blockUICss})}),$(".closeRunAllModal").on("click",function(){$(".modal").hide()}),document.getElementById("runAll").addEventListener("click",function(){$(".modal").show()}),document.getElementById("getTestClasses").addEventListener("click",function(){$.blockUI({message:"<span>Working on it..</span>",css:blockUICss}),chrome.tabs.sendMessage(e[0].id,{execute:"getTestClasses"},function(e){})}),document.getElementById("runSelected").addEventListener("click",function(){var s={execute:"runSelected",selectedTests:selectedTests};chrome.tabs.sendMessage(e[0].id,s,function(e){}),$("#coverageDiv").hide(),$("#getCoverageReport").hide(),selectedTests=[],$("#specificTests input:checked").each(function(){$(this).prop("checked",!1)}),$.blockUI({message:"<span>Queueing selected tests..</span>",css:blockUICss})}),document.getElementById("getCoverageReport").addEventListener("click",function(){getCSV(coverageCSV,"CoverageReport")}),document.getElementById("ApexTestQueuePage").addEventListener("click",function(){chrome.tabs.sendMessage(e[0].id,{execute:"openStandardPage",page:"ApexTestQueuePage"},function(e){})}),document.getElementById("getTestResults").addEventListener("click",function(){$.blockUI({message:"<span>Working on it..</span>",css:blockUICss}),chrome.tabs.sendMessage(e[0].id,{execute:"getTestResults"},function(e){})})):($.unblockUI(),$.blockUI({message:"<span>Please open in Salesforce window/tab.</span>",css:blockUICss}))}),chrome.runtime.onMessage.addListener(function(e,s,t){({coverage:updateCoverage,orgWideCoverage:updateOrgWideCoverage,getTestClasses:processTestClasses,getTestResults:updateTestResults,getInvalidApexClasses:updateInvalidClasses,successAcknowledgement:successAcknowledgement})[e.type](e)});